#!/usr/bin/env bash
# Goosetown launcher wrapper
# Creates a unique telepathy file for orchestrator â†’ delegate communication via tom

set -e

# Use user-specified goose or find system goose
if [[ -z "${GOOSE_BIN:-}" ]]; then
    GOOSE_BIN="$(command -v goose 2>/dev/null || true)"
fi

if [[ -z "$GOOSE_BIN" ]]; then
    echo "Error: goose not found. Install from https://github.com/block/goose/releases" >&2
    echo "       or set GOOSE_BIN to the path of your goose binary." >&2
    exit 1
fi

# Generate unique telepathy file for this session
TELEPATHY_FILE="/tmp/goose-telepathy-$$.txt"
touch "$TELEPATHY_FILE"

# Export for tom extension - orchestrator and all delegates will see this
export GOOSE_MOIM_MESSAGE_FILE="$TELEPATHY_FILE"

# Generate unique wall file for this session
WALLS_DIR="${HOME}/.goosetown/walls"
mkdir -p "$WALLS_DIR"
WALL_FILE="${WALLS_DIR}/wall-$$-${RANDOM}.log"
touch "$WALL_FILE"
export GOOSE_GTWALL_FILE="$WALL_FILE"

# Orchestrator tuning defaults (can be overridden by env)
export GOOSE_AUTO_COMPACT_THRESHOLD="${GOOSE_AUTO_COMPACT_THRESHOLD:-0.97}"
export GOOSE_SUBAGENT_MAX_TURNS="${GOOSE_SUBAGENT_MAX_TURNS:-250}"
export GOOSE_MAX_BACKGROUND_TASKS="${GOOSE_MAX_BACKGROUND_TASKS:-24}"

# Cleanup on exit
cleanup() {
    rm -f "$TELEPATHY_FILE"
    rm -f "$WALL_FILE"
    rm -rf "${WALL_FILE%.log}.positions"
}
trap cleanup EXIT

echo "ðŸ¦† Goosetown telepathy enabled: $TELEPATHY_FILE" >&2
echo "ðŸ¦† Goosetown wall enabled: $WALL_FILE" >&2

"$GOOSE_BIN" "$@"
